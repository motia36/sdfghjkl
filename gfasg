import telebot

TOKEN = '7628595465:AAHgUHi-smK7UE8XayKD8ms_EBTF6PsqV-4'
bot = telebot.TeleBot(TOKEN)

teachers = {
    '–ò–ª—å—è': {
        'photo': 'https://static.wikia.nocookie.net/smesharikiarhives/images/c/c1/%D0%9A%D1%80%D0%BE%D1%88_%D0%A2%D0%97.png/revision/latest?cb=20200929162518&path-prefix=ru',
        'courses': 'Python, WEB',
        'likes': 0,
        'dislikes': 0,
        'voted': []
    },
    '–ö–∏—Ä–∏–ª–ª': {
        'photo': 'https://static.wikia.nocookie.net/smesharikiarhives/images/b/b7/%D0%81%D0%B6%D0%B8%D0%BA_%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%BD%D1%8B%D0%B9_%D0%B7%D0%BD%D0%B0%D0%BA.png/revision/latest?cb=20200929162643&path-prefix=ru',
        'courses': 'Roblox, Game ART',
        'likes': 0,
        'dislikes': 0,
        'voted': []
    },
    '–ú–∞—à–∞': {
        'photo': 'https://static.wikia.nocookie.net/smesharikiarhives/images/b/ba/%D0%9D%D1%8E%D1%88%D0%B0_%D0%A2%D0%97.png/revision/latest?cb=20200929163906&path-prefix=ru',
        'courses': 'Scratch, WEB',
        'likes': 0,
        'dislikes': 0,
        'voted': []
    },
    '–ù–∞—Å—Ç—è': {
        'photo': 'https://static.wikia.nocookie.net/smesharikiarhives/images/2/24/%D0%A1%D0%BE%D0%B2%D1%83%D0%BD%D1%8C%D1%8F_%D1%82%D0%BE%D0%B2%D0%B0%D1%80%D0%BD%D1%8B%D0%B9_%D0%B7%D0%BD%D0%B0%D0%BA.png/revision/latest?cb=20200929163742&path-prefix=ru',
        'courses': 'Scratch, Roblox',
        'likes': 0,
        'dislikes': 0,
        'voted': []
    },
    '–ï–≥–æ—Ä': {
        'photo': 'https://static.wikia.nocookie.net/smesharikiarhives/images/0/0a/%D0%9A%D0%BE%D0%BF%D0%B0%D1%82%D1%8B%D1%87_%D0%A2%D0%97.png/revision/latest?cb=20200929163704&path-prefix=ru',
        'courses': 'Python, Game ART',
        'likes': 0,
        'dislikes': 0,
        'voted': []
    }
}

courses = {
    'Python': ['–ò–ª—å—è', '–ï–≥–æ—Ä'],
    'Scratch': ['–ú–∞—à–∞', '–ù–∞—Å—Ç—è'],
    'WEB': ['–ò–ª—å—è', '–ú–∞—à–∞'],
    'Roblox': ['–ö–∏—Ä–∏–ª–ª', '–ù–∞—Å—Ç—è'],
    'Game ART': ['–ï–≥–æ—Ä', '–ö–∏—Ä–∏–ª–ª']
}

@bot.message_handler(commands=['start'])
def start_message(message):
    keyboard = telebot.types.InlineKeyboardMarkup()
    evaluate = telebot.types.InlineKeyboardButton('–û—Ü–µ–Ω–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è', callback_data='evaluate')
    rating = telebot.types.InlineKeyboardButton('–†–µ–π—Ç–∏–Ω–≥ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π', callback_data='rating')
    keyboard.add(evaluate)
    keyboard.add(rating)
    bot.send_message(message.chat.id, '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –∏–∑ –¥–µ–π—Å—Ç–≤–∏–π:', reply_markup=keyboard)

@bot.callback_query_handler(lambda callback: True)
def callback_handler(callback):
    user_id = callback.message.chat.id
    data = callback.data
    if data == 'evaluate':
        keyboard = telebot.types.InlineKeyboardMarkup()
        for course in courses.keys():
            keyboard.add(telebot.types.InlineKeyboardButton(course, callback_data=course))
        bot.send_message(user_id, '–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å:', reply_markup=keyboard)
    elif data in courses:
        keyboard = telebot.types.InlineKeyboardMarkup()
        for teacher in courses[data]:
            keyboard.add(telebot.types.InlineKeyboardButton(teacher, callback_data=teacher))
        bot.send_message(user_id, '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:', reply_markup=keyboard)
    elif data in teachers:
        info = (
            f'–ò–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: {data}\n'
            f'–ö–∞–∫–∏–µ –∫—É—Ä—Å—ã –ø—Ä–µ–ø–æ–¥–∞—ë—Ç: {teachers[data]["courses"]}\n'
            f'–õ–∞–π–∫–æ–≤: {teachers[data]["likes"]}, –î–∏–∑–ª–∞–π–∫–æ–≤: {teachers[data]["dislikes"]}'
        )
        keyboard = telebot.types.InlineKeyboardMarkup()
        like = telebot.types.InlineKeyboardButton('üëç', callback_data=f'like_{data}')
        dislike = telebot.types.InlineKeyboardButton('üëé', callback_data=f'dislike_{data}')
        keyboard.add(like, dislike)
        bot.send_photo(user_id, teachers[data]['photo'])
        bot.send_message(user_id, info, reply_markup=keyboard)
    elif data.startswith('like'):
        name = data.split('_')[1]
        if user_id in teachers[name]['voted']:
            bot.send_message(user_id, '–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è!')
        else:
            teachers[name]['likes'] += 1
            teachers[name]['voted'].append(user_id)
            bot.send_message(user_id, '–í–∞—à –≥–æ–ª–æ—Å –∑–∞–ø–∏—Å–∞–Ω!')
    elif data.startswith('dislike'):
        name = data.split('_')[1]
        if user_id in teachers[name]['voted']:
            bot.send_message(user_id, '–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è!')
        else:
            teachers[name]['dislikes'] += 1
            teachers[name]['voted'].append(user_id)
            bot.send_message(user_id, '–í–∞—à –≥–æ–ª–æ—Å –∑–∞–ø–∏—Å–∞–Ω!')
    elif data == 'rating':
        rating = []
        for name, info in teachers.items():
            votes = info['likes'] + info['dislikes']
            rating.append((name, (info['likes'] - info['dislikes']) / votes))
        rating.sort(key=lambda x: -x[1])
        result = '–¢–û–ü-3 –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —à–∫–æ–ª—ã Movavi:\n\n'
        for i, teacher in enumerate(rating[:3]):
            result += f'‚Ññ{i + 1}: {teacher[0]} ({teacher[1]:.2f})\n'
        bot.send_message(user_id, result)

print('bot is running')
bot.polling(
    none_stop=True,
    interval=1
)
